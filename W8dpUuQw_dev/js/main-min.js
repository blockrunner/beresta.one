navigator.bluetooth||alert("Sorry, your browser doesn't support Bluetooth API");const sleep=e=>new Promise((t=>setTimeout(t,e))),convertToByteMatrix=e=>e.map((t=>t.toString(2).padStart(e.length,"0").split(""))),convertToHexArray=e=>e.map((e=>parseInt(e.join(""),2).toString(16))),nullMatrix=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],MY_BLUETOOTH_NAME="WEB-CLIENT";let toggleLigthCharacteristic,myDevice;function connectButton(){log.add("request device...");let e=Number(document.getElementById("bl-service").value),t=Number(document.getElementById("bl-char").value);navigator.bluetooth.requestDevice({filters:[{name:"WEB-CLIENT"},{services:[e]}]}).then((e=>(myDevice=e,log.add("connect.."),console.log(myDevice),e.gatt.connect()))).then((t=>t.getPrimaryService(e))).then((e=>e.getCharacteristic(t))).then((e=>{toggleLigthCharacteristic=e,log.add("connected"),blSendCommand("engine-on"),setTimeout((()=>{document.getElementById("hand-right").click()}),500),console.log(toggleLigthCharacteristic)})).catch((e=>{log.add("error. details in console"),console.error(e)}))}function writeValues(e,t=0){if(t===e.length)return;e[t];let a=e[t+1]?[...convertToDeviceMatrix(e[t]),...convertToDeviceMatrix(e[t+1])]:[...convertToDeviceMatrix(e[t]),...nullMatrix];toDeviceDataHex=[],a.forEach((e=>{toDeviceDataHex.push("0x"+parseInt(objToString(e),2).toString(16))}));let n=(new TextEncoder).encode("!E"),s=(new TextEncoder).encode("#");combined=new Uint8Array(n.length+toDeviceDataHex.length+s.length),combined.set(n,0),combined.set(toDeviceDataHex,n.length),combined.set(s,n.length+toDeviceDataHex.length),console.log(combined),toggleLigthCharacteristic.writeValue(combined).then((()=>{log.add("write data"),setTimeout((()=>{e[t+2]&&writeValues(e,t+2)}),300)})).catch((e=>{log.add("send command - ERROR"),console.error(`Error writing data: ${e}`)}))}function blSendCommand(e,t=!1,a=!1){if(!toggleLigthCharacteristic)return!1;switch(e){case"write":let n=[];a||(t=[t]),t.forEach((e=>{Array.isArray(e)?e.forEach((e=>{n.push(e)})):((e=e.split("")).length%2!=0&&e.push(" "),e.forEach((e=>{n.push(convertToByteMatrix(letter[e]))})))})),writeValues(n);break;case"play":let s=Number(document.getElementById("render-time").value),d=(new TextEncoder).encode("*T"),o=(new TextEncoder).encode("#"),l=["0x"+decToHex(s)];combined=new Uint8Array(d.length+l.length+o.length),combined.set(d,0),combined.set(l,d.length),combined.set(o,d.length+l.length),console.log(combined),toggleLigthCharacteristic.writeValue(combined).then((()=>{let a=Number(document.getElementById("pause-time").value),n=(new TextEncoder).encode("*U"),s=(new TextEncoder).encode("#"),d=["0x"+decToHex(a)];combined=new Uint8Array(n.length+d.length+s.length),combined.set(n,0),combined.set(d,n.length),combined.set(s,n.length+d.length),console.log(combined),toggleLigthCharacteristic.writeValue(combined).then((()=>{t=(new TextEncoder).encode("*SE#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then((()=>{log.add(`${e} command`)})).catch((t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)}))}))}));break;case"pause":case"stop":t=(new TextEncoder).encode("*SP#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then((()=>{log.add(`${e} command`)})).catch((t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)}));break;case"clear":t=(new TextEncoder).encode("*EE#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then((()=>{log.add(`${e} command`)})).catch((t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)}));break;case"engine-on":t=(new TextEncoder).encode("*M+#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then((()=>{log.add(`${e} command`)})).catch((t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)}));break;case"hand":cmd="left"===t?(new TextEncoder).encode("*HL#"):(new TextEncoder).encode("*HR#"),console.log(cmd),toggleLigthCharacteristic.writeValue(cmd).then((()=>{log.add(`${e} ${t} command`)})).catch((a=>{log.add(`${e} ${t} command - ERROR`),console.error(`Error writing data: ${a}`)}));break;case"test-engines":switch(t){case"enable":cmd=(new TextEncoder).encode("*M+#");break;case"disable":cmd=(new TextEncoder).encode("*M-#");break;case"deviation":cmd=(new TextEncoder).encode("*MT#")}console.log(cmd),toggleLigthCharacteristic.writeValue(cmd).then((()=>{log.add(`${e} ${t} command`)})).catch((a=>{log.add(`${e} ${t} command - ERROR`),console.error(`Error writing data: ${a}`)}));break;default:return!1}}function convertToDeviceMatrix(e){let t=[];for(let a=0;a<e[0].length;a++){let n=[];for(let t=0;t<e.length;t++)n.push(e[t][a]);t.push(n)}return t}class Log{logsArea=document.getElementById("logs");add(e){this.logsArea.value+=`${e}\n`}}let log=new Log;function drawToMatrix(e){for(i=0;i<e.length;i++)for(ii=0;ii<e[i].length;ii++)1==e[i][ii]&&document.getElementById(`pixel-${i}-${[ii+1]}`).classList.add("on")}class Fbf{static field=document.getElementsByClassName("fbf-line-div")[0];static array=[];static Add(e){this.array.push(e)}static Update(){let e="";void 0===this.array[0]&&(this.array=[]),this.array.forEach((t=>{Array.isArray(t)?e+=this.getMinMatrix(t):e+=t,e+='<div class="vertical-line"></div>'})),this.field.innerHTML=e,""===e?document.getElementById("fbf-clean").classList.add("disabled"):document.getElementById("fbf-clean").classList.remove("disabled")}static getMinMatrix(e){let t=["",""];for(let a=0;a<2;a++)e[a].forEach((e=>{for(let n=0;n<e.length;n++)1===e[n]?t[a]+='<dot class="true"></dot>':t[a]+='<dot class="false"></dot>',0!==n&&n%7==0&&(t[a]+='</div><div class="dot-row">')}));return t=`<div class="line-dots"><span><div class="dot-row">${t[0]}</div></span></div>\n              <div class="line-dots"><span><div class="dot-row">${t[1]}</div></span></div>`,t}}class Queue{field=document.getElementsByClassName("text-line-div")[0];array=[];AddText(e){let t=!0;e.split("").forEach((e=>{letter[e]||(alert(`Символ '${e}' не найден в таблице`),t=!1)})),t&&(this.array.push({type:"text",preview:e,data:e}),blSendCommand("write",e),document.getElementById("queue-save").classList.remove("disabled"),document.getElementById("queue-save").classList.add("default"))}AddMatrix(e){this.array.push({type:"array",preview:e,data:e}),document.getElementById("queue-save").classList.remove("disabled"),document.getElementById("queue-save").classList.add("default"),blSendCommand("write",e)}AddMergeMatrix(e,t){this.array.push({type:"merged",preview:t,data:e}),document.getElementById("queue-save").classList.remove("disabled"),document.getElementById("queue-save").classList.add("default"),blSendCommand("write",e,!0)}Update(){let e="";void 0===this.array[0]&&(this.array=[]),this.array.forEach((t=>{Array.isArray(t.preview)?e+=this.getMinMatrix(t.preview):e+=t.preview,e+='<div class="vertical-line"></div>'})),this.field.innerHTML=e}getMinMatrix(e){let t=["",""];for(let a=0;a<2;a++)e[a].forEach((e=>{for(let n=0;n<e.length;n++)1===e[n]?t[a]+='<dot class="true"></dot>':t[a]+='<dot class="false"></dot>',0!==n&&n%7==0&&(t[a]+='</div><div class="dot-row">')}));return t=`<div class="line-dots"><span><div class="dot-row">${t[0]}</div></span></div>\n              <div class="line-dots"><span><div class="dot-row">${t[1]}</div></span></div>`,t}}class Matrix{bytes=[];enabled=!1;renderArr=[];drawIntervalId;convertToByteMatrix=e=>e.map((t=>t.toString(2).padStart(e.length,"0").split("")));Load(e){if(this.bytes=[],e)switch(e.type){case"text":sendHttpPost("log-add",{"log-action":"draw","log-type":"txt","log-msg":e.preview}),e.data=e.data.split(""),e.data.forEach((e=>{this.bytes.push(this.convertToByteMatrix(letter[e]))}));break;case"array":sendHttpPost("log-add",{"log-action":"draw","log-type":"img","log-msg":e.preview}),e.data.forEach((e=>{this.bytes.push(e)}));break;case"merged":sendHttpPost("log-add",{"log-action":"draw","log-type":"merged img","log-msg":e.preview}),e.data.forEach((e=>{e.forEach((e=>{this.bytes.push(e)}))}))}else alert("Нет матриц в очереди")}Draw(){let e,t=Number(1e3*document.getElementById("render-time").value),a=Number(1e3*document.getElementById("pause-time").value),n=t+a,s=0;const d=()=>{if(e=1,setTimeout(this.Clear,t),1!==States.play)return clearInterval(this.drawIntervalId),void this.EndRender();if(!this.bytes[s])return clearInterval(this.drawIntervalId),void this.EndRender();console.log(this.bytes);for(let t=0;t<this.bytes[s].length;t++)for(let a=0;a<this.bytes[s][t].length;a++)1==this.bytes[s][t][a]&&document.getElementById(`pixel-${e}-${t}-${[a]}`).classList.add("on");if(s++,e=2,this.bytes[s]){for(let t=0;t<this.bytes[s].length;t++)for(let a=0;a<this.bytes[s][t].length;a++)1==this.bytes[s][t][a]&&document.getElementById(`pixel-${e}-${t}-${[a]}`).classList.add("on");s++,e=1,setTimeout(d,0===s?1e3:n)}else setTimeout((()=>{clearInterval(this.drawIntervalId),this.EndRender()}),t)};this.drawIntervalId=setTimeout(d,0===s?1e3:n)}Clear(){let e=document.getElementsByClassName("pixel");for(let t=0;t<e.length;t++)e[t].classList.remove("on")}EndRender(){1===States.play&&(States.enabled=!1);let e=queue.array.splice(0,1)[0];queue.array.splice(queue.array.length,1,e),queue.Update()}}class States{static play=-1;static nowInput=0;static playIntervalId;static enabled=!1;static random=!1;static playTimeouts=[];static Update(){switch(this.play){case 1:document.getElementById("play").classList.add("disabled"),document.getElementById("pause").classList.remove("disabled"),document.getElementById("stop").classList.remove("disabled"),document.getElementById("clear").classList.add("disabled");break;case 0:document.getElementById("play").classList.remove("disabled"),document.getElementById("pause").classList.add("disabled"),document.getElementById("stop").classList.remove("disabled"),document.getElementById("clear").classList.add("disabled");break;case-1:queue.array.length>0?(document.getElementById("play").classList.remove("disabled"),document.getElementById("clear").classList.remove("disabled"),document.getElementById("pause").classList.add("disabled"),document.getElementById("stop").classList.add("disabled")):(document.getElementById("clear").classList.add("disabled"),document.getElementById("queue-save").classList.remove("default"),document.getElementById("queue-save").classList.add("disabled"))}}}let queue=new Queue,matrix=new Matrix;States.Update(),document.addEventListener("click",(function(e){if(!e.target.classList.contains("disabled"))switch(console.log(e.target.id),-1!==e.target.id.indexOf("input-pixel")&&document.getElementById(e.target.id).classList.toggle("on"),e.target.id){case"text-active-button":document.getElementById("text-active-button").classList.add("active"),document.getElementById("text-input-field").classList.remove("none"),document.getElementById("matrix-active-button").classList.remove("active"),document.getElementById("matrix-input-field").classList.add("none"),document.getElementById("fbf-send").classList.add("disabled"),States.nowInput=0;break;case"matrix-active-button":document.getElementById("text-active-button").classList.remove("active"),document.getElementById("text-input-field").classList.add("none"),document.getElementById("matrix-active-button").classList.add("active"),document.getElementById("matrix-input-field").classList.remove("none"),document.getElementById("fbf-send").classList.remove("disabled"),States.nowInput=1;break;case"random-enable":States.random=!0,document.getElementById("random-disable").classList.remove("active"),document.getElementById("random-enable").classList.add("active");break;case"random-disable":States.random=!1,document.getElementById("random-enable").classList.remove("active"),document.getElementById("random-disable").classList.add("active");break;case"hand-left":blSendCommand("hand","left"),document.getElementById("hand-right").classList.remove("active"),document.getElementById("hand-left").classList.add("active");break;case"hand-right":blSendCommand("hand","right"),document.getElementById("hand-right").classList.add("active"),document.getElementById("hand-left").classList.remove("active");break;case"test-enable":blSendCommand("test-engines","enable");break;case"test-disable":blSendCommand("test-engines","disable");break;case"test-deviation":blSendCommand("test-engines","deviation");break;case"test-stop":blSendCommand("stop");break;case"log-clear":confirm("Вы действительно хотите очистить файл лога?")&&sendHttpPost("log-clear");break;case"input-send":switch(States.nowInput){case 0:let e=document.getElementById("text-input-field").value.trim();if(!e)return void alert("Не введен текст");queue.AddText(e),queue.Update(),States.Update();break;case 1:if(""===Fbf.field.innerHTML){let e=document.getElementsByClassName("input-pixel"),t=!0,a=[[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]];for(let n in e)if(e[n].classList&&e[n].classList.contains("on")){t=!1;let s=e[n].id.match(/\d+/g);s=s.map((function(e){return parseInt(e)})),a[s[0]-1][s[1]][s[2]]=1}if(t)return alert("Рисунок пуст"),!1;queue.AddMatrix(a)}else queue.AddMergeMatrix(Fbf.array,mergeMatrices(JSON.parse(JSON.stringify(Fbf.array)))),Fbf.array=[],Fbf.Update();queue.Update(),States.Update()}break;case"fbf-send":let t=document.getElementsByClassName("input-pixel"),a=!0,n=[[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]];for(let e in t)if(t[e].classList&&t[e].classList.contains("on")){a=!1;let s=t[e].id.match(/\d+/g);s=s.map((function(e){return parseInt(e)})),n[s[0]-1][s[1]][s[2]]=1}if(a)return alert("Рисунок пуст"),!1;Fbf.Add(n),Fbf.Update();break;case"play":if(0===queue.array.length)return void alert("Нет матриц в очереди");sendHttpPost("log-add",{"log-action":"start","log-type":"command","log-msg":"-"}),States.random||blSendCommand("play"),States.play=1,States.Update(),States.enabled=!1,States.playIntervalId=setInterval((()=>{States.enabled||(States.enabled=!0,States.random?States.playTimeouts[0]=setTimeout((()=>{shuffleArray(queue.array),queue.Update(),blSendCommand("clear"),States.playTimeouts[1]=setTimeout((()=>{blSendCommand("write",queue.array[0]),States.playTimeouts[2]=setTimeout((()=>{blSendCommand("play"),matrix.Load(queue.array[0]),matrix.Draw()}),500)}),2e3)}),500):(matrix.Load(queue.array[0]),matrix.Draw()))}),50);break;case"pause":sendHttpPost("log-add",{"log-action":"pause","log-type":"command","log-msg":"-"}),blSendCommand("pause"),States.play=0,States.Update(),States.playTimeouts.forEach((e=>{clearTimeout(e)}));break;case"stop":sendHttpPost("log-add",{"log-action":"stop","log-type":"command","log-msg":"-"}),blSendCommand("stop"),States.play=-1,States.Update(),clearInterval(States.playIntervalId),States.playTimeouts.forEach((e=>{clearTimeout(e)}));break;case"clear":blSendCommand("clear"),queue.array=[],queue.field.innerHTML="",States.Update();break;case"fbf-clean":Fbf.array=[],Fbf.field.innerHTML="",Fbf.Update();break;case"connect":connectButton();break;case"queue-save":let s=prompt("Введите имя шаблона");if(!s)return!1;Api.queueSave(s,queue.array);break;case"queue-load":Api.queueLoad();break;case"load-modal-list":let d=JSON.parse(e.target.attributes.data.value);queue.array=d,queue.Update(),blSendCommand("clear"),dataArray=[],d.forEach((e=>{dataArray.push(...e.data)})),setTimeout((()=>{blSendCommand("write",dataArray,!0)}),2e3);break;case"remove-modal-list":sendHttpPost("queue-remove",{id:e.target.attributes.data_id.value}),e.target.parentElement.remove()}}));class Api{static queueSave(e,t){sendHttpPost("queue-save",{name:e,data:t})}static queueLoad(){sendHttpPost("queue-load","",queueLoaded)}}function queueLoaded(e){let t="";e.forEach((e=>{t_data=JSON.stringify(e.data),t+=`\n          <li>\n            ${e.name}\n            <button data='${t_data}' id="load-modal-list">Загрузить</button>\n            <button data_id='${e.id}' id="remove-modal-list">Удалить</button>\n          </li>\n          `}));let a=`<div class="modal-content">\n        <span class="close" onclick="closeModal()">&times;</span>\n        <ul>\n          ${t}\n        </ul>\n      </div>`;document.getElementById("load-modal").innerHTML=a,openModal()}let modal=document.getElementById("load-modal"),closeButton=document.getElementsByClassName("close")[0];function openModal(){modal.style.display="block"}function closeModal(){modal.style.display="none"}window.onclick=function(e){e.target==modal&&closeModal()};let cells=document.querySelectorAll(".input-pixel"),isMouseDown=!1,isOn=!0;function addClassToCells(e){for(let t=0;t<e.length;t++)e[t].classList.add("on")}function removeClassFromCells(e){for(let t=0;t<e.length;t++)e[t].classList.remove("on")}function sendHttpPost(e,t,a,n){const s=new XMLHttpRequest;url="api.php?method=",s.open("POST",url+e),s.setRequestHeader("Content-Type","application/json"),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE)if(200===s.status){let e=JSON.parse(s.responseText);a&&"success"==e.msg&&a(e.data.data)}else console.error(s.status)},s.send(JSON.stringify(t))}function objToString(e){var t="";for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t+=e[a]);return t}function decToHex(e){return e.toString(16).padStart(2,"0")}function shuffleArray(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}function mergeMatrices(e){let t=e[0];for(let a=1;a<e.length;a++){let n=e[a];for(let e=0;e<n.length;e++){let a=n[e];for(let n=0;n<a.length;n++){let s=a[n];for(let a=0;a<s.length;a++)t[e][n][a]=(t[e][n][a]||0)+s[a],t[e][n][a]=t[e][n][a]>0?1:0}}}return t}document.addEventListener("mousedown",(function(e){isMouseDown=!0,e.target.classList.contains("on")&&(isOn=!1)})),document.addEventListener("mouseup",(function(e){isMouseDown=!1,isOn=!0})),document.addEventListener("mousemove",(function(e){if(isMouseDown){let e=document.querySelectorAll(".input-pixel:hover");isOn?addClassToCells(e):removeClassFromCells(e)}}));