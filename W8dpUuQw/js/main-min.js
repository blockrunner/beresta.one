navigator.bluetooth||alert("Sorry, your browser doesn't support Bluetooth API");const TEST_ENV=!1,sleep=e=>new Promise(t=>setTimeout(t,e)),convertToByteMatrix=e=>e.map(t=>t.toString(2).padStart(e.length,"0").split("")),convertToHexArray=e=>e.map(e=>parseInt(e.join(""),2).toString(16)),nullMatrix=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],MY_BLUETOOTH_NAME="WEB-CLIENT";let toggleLigthCharacteristic,myDevice;function connectButton(){log.add("request device...");let e=Number(document.getElementById("bl-service").value),t=Number(document.getElementById("bl-char").value);navigator.bluetooth.requestDevice({filters:[{name:"WEB-CLIENT"},{services:[e]},]}).then(e=>(myDevice=e,log.add("connect.."),console.log(myDevice),e.gatt.connect())).then(t=>t.getPrimaryService(e)).then(e=>e.getCharacteristic(t)).then(e=>{toggleLigthCharacteristic=e,log.add("connected"),blSendCommand("engine-on"),setTimeout(()=>{document.getElementById("hand-right").click()},500),console.log(toggleLigthCharacteristic)}).catch(e=>{log.add("error. details in console"),console.error(e)})}function writeValues(e,t=0){if(t===e.length)return;e[t];let a;toDeviceDataHex=[],(e[t+1]?[...convertToDeviceMatrix(e[t]),...convertToDeviceMatrix(e[t+1])]:[...convertToDeviceMatrix(e[t]),...nullMatrix]).forEach(e=>{toDeviceDataHex.push("0x"+parseInt(objToString(e),2).toString(16))});let s=new TextEncoder().encode("!E"),l=new TextEncoder().encode("#");(combined=new Uint8Array(s.length+toDeviceDataHex.length+l.length)).set(s,0),combined.set(toDeviceDataHex,s.length),combined.set(l,s.length+toDeviceDataHex.length),console.log(combined),toggleLigthCharacteristic.writeValue(combined).then(()=>{log.add("write data"),setTimeout(()=>{e[t+2]&&writeValues(e,t+2)},300)}).catch(e=>{log.add("send command - ERROR"),console.error(`Error writing data: ${e}`)})}function blSendCommand(e,t=!1,a=!1){if(!toggleLigthCharacteristic)return!1;switch(e){case"write":let s=[];a||(t=[t]),t.forEach(e=>{Array.isArray(e)?e.forEach(e=>{s.push(e)}):((e=e.split("")).length%2!=0&&e.push(" "),e.forEach(e=>{s.push(convertToByteMatrix(letter[e]))}))}),writeValues(s);break;case"play":let l=Number(document.getElementById("render-time").value),n=new TextEncoder().encode("*T"),d=new TextEncoder().encode("#"),r=["0x"+decToHex(l)];(combined=new Uint8Array(n.length+r.length+d.length)).set(n,0),combined.set(r,n.length),combined.set(d,n.length+r.length),console.log(combined),toggleLigthCharacteristic.writeValue(combined).then(()=>{t=new TextEncoder().encode("*SE#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then(()=>{log.add(`${e} command`)}).catch(t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)})});break;case"pause":t=new TextEncoder().encode("*SP#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then(()=>{log.add(`${e} command`)}).catch(t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)});break;case"stop":t=new TextEncoder().encode("*SP#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then(()=>{log.add(`${e} command`)}).catch(t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)});break;case"clear":t=new TextEncoder().encode("*EE#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then(()=>{log.add(`${e} command`)}).catch(t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)});break;case"engine-on":t=new TextEncoder().encode("*M+#"),console.log(t),toggleLigthCharacteristic.writeValue(t).then(()=>{log.add(`${e} command`)}).catch(t=>{log.add(`${e} command - ERROR`),console.error(`Error writing data: ${t}`)});break;case"hand":cmd="left"===t?new TextEncoder().encode("*HL#"):new TextEncoder().encode("*HR#"),console.log(cmd),toggleLigthCharacteristic.writeValue(cmd).then(()=>{log.add(`${e} ${t} command`)}).catch(a=>{log.add(`${e} ${t} command - ERROR`),console.error(`Error writing data: ${a}`)});break;case"test-engines":switch(t){case"enable":cmd=new TextEncoder().encode("*M+#");break;case"disable":cmd=new TextEncoder().encode("*M-#");break;case"deviation":cmd=new TextEncoder().encode("*MT#")}console.log(cmd),toggleLigthCharacteristic.writeValue(cmd).then(()=>{log.add(`${e} ${t} command`)}).catch(a=>{log.add(`${e} ${t} command - ERROR`),console.error(`Error writing data: ${a}`)});break;default:return!1}}function convertToDeviceMatrix(e){let t=[];for(let a=0;a<e[0].length;a++){let s=[];for(let l=0;l<e.length;l++)s.push(e[l][a]);t.push(s)}return t}class Log{logsArea=document.getElementById("logs");add(e){this.logsArea.value+=`${e}
`}}let log=new Log;function drawToMatrix(e){for(i=0;i<e.length;i++)for(ii=0;ii<e[i].length;ii++)1==e[i][ii]&&document.getElementById(`pixel-${i}-${[ii+1]}`).classList.add("on")}class Queue{field=document.getElementsByClassName("text-line-div")[0];array=[];AddText(e){let t=!0;e.split("").forEach(e=>{letter[e]||(alert(`Символ '${e}' не найден в таблице`),t=!1)}),t&&(this.array.push(e),blSendCommand("write",e),document.getElementById("queue-save").classList.remove("disabled"),document.getElementById("queue-save").classList.add("default"))}AddMatrix(e){this.array.push(e),document.getElementById("queue-save").classList.remove("disabled"),document.getElementById("queue-save").classList.add("default"),blSendCommand("write",e)}Update(){let e="";void 0===this.array[0]&&(this.array=[]),this.array.forEach(t=>{Array.isArray(t)?e+=this.getMinMatrix(t):e+=t,e+='<div class="vertical-line"></div>'}),this.field.innerHTML=e}getMinMatrix(e){let t=["",""];for(let a=0;a<2;a++)e[a].forEach(e=>{for(let s=0;s<e.length;s++)1===e[s]?t[a]+='<dot class="true"></dot>':t[a]+='<dot class="false"></dot>',0!==s&&s%7==0&&(t[a]+='</div><div class="dot-row">')});return t=`<div class="line-dots"><span><div class="dot-row">${t[0]}</div></span></div>
              <div class="line-dots"><span><div class="dot-row">${t[1]}</div></span></div>`}}class Matrix{bytes=[];enabled=!1;renderArr=[];drawIntervalId;convertToByteMatrix=e=>e.map(t=>t.toString(2).padStart(e.length,"0").split(""));Load(e){if(this.bytes=[],!e){alert("Нет матриц в очереди");return}Array.isArray(e)?(sendHttpPost("log-add",{"log-action":"draw","log-type":"img","log-msg":e}),e.forEach(e=>{this.bytes.push(e)})):(sendHttpPost("log-add",{"log-action":"draw","log-type":"txt","log-msg":e}),(e=e.split("")).forEach(e=>{this.bytes.push(this.convertToByteMatrix(letter[e]))}))}Draw(){let e=Number(1e3*document.getElementById("render-time").value),t=e+0,a,s=0,l=()=>{if(a=1,setTimeout(this.Clear,e),1!==States.play||!this.bytes[s]){clearInterval(this.drawIntervalId),this.EndRender();return}for(let n=0;n<this.bytes[s].length;n++)for(let d=0;d<this.bytes[s][n].length;d++)1==this.bytes[s][n][d]&&document.getElementById(`pixel-${a}-${n}-${[d]}`).classList.add("on");if(s++,a=2,!this.bytes[s]){setTimeout(()=>{clearInterval(this.drawIntervalId),this.EndRender()},e);return}for(let r=0;r<this.bytes[s].length;r++)for(let o=0;o<this.bytes[s][r].length;o++)1==this.bytes[s][r][o]&&document.getElementById(`pixel-${a}-${r}-${[o]}`).classList.add("on");a=1,setTimeout(l,0==++s?1e3:t)};this.drawIntervalId=setTimeout(l,0===s?1e3:t)}Clear(){let e=document.getElementsByClassName("pixel");for(let t=0;t<e.length;t++)e[t].classList.remove("on")}EndRender(){1===States.play&&(States.enabled=!1);let e=queue.array.splice(0,1)[0];queue.array.splice(queue.array.length,1,e),queue.Update()}}class States{static play=-1;static nowInput=0;static playIntervalId;static enabled=!1;static random=!1;static playTimeouts=[];static Update(){switch(this.play){case 1:document.getElementById("play").classList.add("disabled"),document.getElementById("pause").classList.remove("disabled"),document.getElementById("stop").classList.remove("disabled"),document.getElementById("clear").classList.add("disabled");break;case 0:document.getElementById("play").classList.remove("disabled"),document.getElementById("pause").classList.add("disabled"),document.getElementById("stop").classList.remove("disabled"),document.getElementById("clear").classList.add("disabled");break;case -1:queue.array.length>0?(document.getElementById("play").classList.remove("disabled"),document.getElementById("clear").classList.remove("disabled"),document.getElementById("pause").classList.add("disabled"),document.getElementById("stop").classList.add("disabled")):(document.getElementById("clear").classList.add("disabled"),document.getElementById("queue-save").classList.remove("default"),document.getElementById("queue-save").classList.add("disabled"))}}}let queue=new Queue,matrix=new Matrix;States.Update(),document.addEventListener("click",function(e){if(!e.target.classList.contains("disabled"))switch(console.log(e.target.id),-1!==e.target.id.indexOf("input-pixel")&&document.getElementById(e.target.id).classList.toggle("on"),e.target.id){case"text-active-button":document.getElementById("text-active-button").classList.add("active"),document.getElementById("text-input-field").classList.remove("none"),document.getElementById("matrix-active-button").classList.remove("active"),document.getElementById("matrix-input-field").classList.add("none"),States.nowInput=0;break;case"matrix-active-button":document.getElementById("text-active-button").classList.remove("active"),document.getElementById("text-input-field").classList.add("none"),document.getElementById("matrix-active-button").classList.add("active"),document.getElementById("matrix-input-field").classList.remove("none"),States.nowInput=1;break;case"random-enable":States.random=!0,document.getElementById("random-disable").classList.remove("active"),document.getElementById("random-enable").classList.add("active");break;case"random-disable":States.random=!1,document.getElementById("random-enable").classList.remove("active"),document.getElementById("random-disable").classList.add("active");break;case"hand-left":blSendCommand("hand","left"),document.getElementById("hand-right").classList.remove("active"),document.getElementById("hand-left").classList.add("active");break;case"hand-right":blSendCommand("hand","right"),document.getElementById("hand-right").classList.add("active"),document.getElementById("hand-left").classList.remove("active");break;case"test-enable":blSendCommand("test-engines","enable");break;case"test-disable":blSendCommand("test-engines","disable");break;case"test-deviation":blSendCommand("test-engines","deviation");break;case"test-stop":blSendCommand("stop");break;case"log-clear":confirm("Вы действительно хотите очистить файл лога?")&&sendHttpPost("log-clear");break;case"input-send":switch(States.nowInput){case 0:let t=document.getElementById("text-input-field").value.trim();if(!t){alert("Не введен текст");return}queue.AddText(t),queue.Update(),States.Update();break;case 1:let a=document.getElementsByClassName("input-pixel"),s=!0,l=[[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]];for(let n in a)if(a[n].classList&&a[n].classList.contains("on")){s=!1;let d=a[n].id.match(/\d+/g);l[(d=d.map(function(e){return parseInt(e)}))[0]-1][d[1]][d[2]]=1}if(s)return alert("Рисунок пуст"),!1;queue.AddMatrix(l),queue.Update(),States.Update()}break;case"play":if(0===queue.array.length){alert("Нет матриц в очереди");return}sendHttpPost("log-add",{"log-action":"start","log-type":"command","log-msg":"-"}),States.random||blSendCommand("play"),States.play=1,States.Update(),States.enabled=!1,States.playIntervalId=setInterval(()=>{States.enabled||(States.enabled=!0,States.random?States.playTimeouts[0]=setTimeout(()=>{shuffleArray(queue.array),queue.Update(),blSendCommand("clear"),States.playTimeouts[1]=setTimeout(()=>{blSendCommand("write",queue.array[0]),States.playTimeouts[2]=setTimeout(()=>{blSendCommand("play"),matrix.Load(queue.array[0]),matrix.Draw()},500)},2e3)},500):(matrix.Load(queue.array[0]),matrix.Draw()))},50);break;case"pause":sendHttpPost("log-add",{"log-action":"pause","log-type":"command","log-msg":"-"}),blSendCommand("pause"),States.play=0,States.Update(),States.playTimeouts.forEach(e=>{clearTimeout(e)});break;case"stop":sendHttpPost("log-add",{"log-action":"stop","log-type":"command","log-msg":"-"}),blSendCommand("stop"),States.play=-1,States.Update(),clearInterval(States.playIntervalId),States.playTimeouts.forEach(e=>{clearTimeout(e)});break;case"clear":blSendCommand("clear"),queue.array=[],queue.field.innerHTML="",States.Update();break;case"connect":connectButton();break;case"queue-save":let r=prompt("Введите имя шаблона");if(!r)return!1;Api.queueSave(r,queue.array);break;case"queue-load":Api.queueLoad();break;case"load-modal-list":let o=JSON.parse(e.target.attributes.data.value);queue.array=o,queue.Update(),blSendCommand("clear"),setTimeout(()=>{blSendCommand("write",o,!0)},2e3);break;case"remove-modal-list":sendHttpPost("queue-remove",{id:e.target.attributes.data_id.value}),e.target.parentElement.remove()}});class Api{static queueSave(e,t){sendHttpPost("queue-save",{name:e,data:t})}static queueLoad(){sendHttpPost("queue-load","",queueLoaded)}}function queueLoaded(e){let t="";e.forEach(e=>{t+=`
          <li>
            ${e.name}
            <button data='${t_data=JSON.stringify(e.data)}' id="load-modal-list">Загрузить</button>
            <button data_id='${e.id}' id="remove-modal-list">Удалить</button>
          </li>
          `});let a=`<div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <ul>
          ${t}
        </ul>
      </div>`;document.getElementById("load-modal").innerHTML=a,openModal()}let modal=document.getElementById("load-modal"),closeButton=document.getElementsByClassName("close")[0];function openModal(){modal.style.display="block"}function closeModal(){modal.style.display="none"}window.onclick=function(e){e.target==modal&&closeModal()};let cells=document.querySelectorAll(".input-pixel"),isMouseDown=!1,isOn=!0;function addClassToCells(e){for(let t=0;t<e.length;t++)e[t].classList.add("on")}function removeClassFromCells(e){for(let t=0;t<e.length;t++)e[t].classList.remove("on")}function sendHttpPost(e,t,a,s){let l=new XMLHttpRequest;url="api.php?method=",l.open("POST",url+e),l.setRequestHeader("Content-Type","application/json"),l.onreadystatechange=function(){if(l.readyState===XMLHttpRequest.DONE){if(200===l.status){console.log(l.responseText);let e=JSON.parse(l.responseText);a&&"success"==e.msg&&a(e.data.data)}else console.error(l.status)}},l.send(JSON.stringify(t))}function objToString(e){var t="";for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t+=e[a]);return t}function decToHex(e){return e.toString(16).padStart(2,"0")}function shuffleArray(e){for(let t=e.length-1;t>0;t--){let a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}document.addEventListener("mousedown",function(e){isMouseDown=!0,e.target.classList.contains("on")&&(isOn=!1)}),document.addEventListener("mouseup",function(e){isMouseDown=!1,isOn=!0}),document.addEventListener("mousemove",function(e){if(isMouseDown){let t=document.querySelectorAll(".input-pixel:hover");isOn?addClassToCells(t):removeClassFromCells(t)}});